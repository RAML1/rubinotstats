// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Worlds reference table
model World {
  id         Int         @id @default(autoincrement())
  name       String      @unique
  pvpType    String?     @map("pvp_type")
  isActive   Boolean     @default(true) @map("is_active")
  createdAt  DateTime    @default(now()) @map("created_at")
  characters Character[]

  @@map("worlds")
}

// Characters (canonical record)
model Character {
  id                  Int                  @id @default(autoincrement())
  name                String
  worldId             Int                  @map("world_id")
  vocation            String?
  guildName           String?              @map("guild_name")
  firstSeen           DateTime             @default(now()) @map("first_seen")
  lastUpdated         DateTime             @default(now()) @updatedAt @map("last_updated")
  world               World                @relation(fields: [worldId], references: [id])
  characterSnapshots  CharacterSnapshot[]

  @@unique([name, worldId])
  @@index([worldId])
  @@index([name])
  @@map("characters")
}

// Daily character snapshots
model CharacterSnapshot {
  id            Int      @id @default(autoincrement())
  characterId   Int      @map("character_id")
  capturedDate  DateTime @map("captured_date")
  level         Int?
  experience    BigInt?
  magicLevel    Int?     @map("magic_level")
  fist          Int?
  club          Int?
  sword         Int?
  axe           Int?
  distance      Int?
  shielding     Int?
  fishing       Int?
  expRank       Int?     @map("exp_rank")
  mlRank        Int?     @map("ml_rank")
  expGained     BigInt?  @map("exp_gained")
  levelsGained  Int?     @map("levels_gained")
  createdAt     DateTime @default(now()) @map("created_at")
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, capturedDate])
  @@index([characterId])
  @@index([capturedDate])
  @@map("character_snapshots")
}

// Sold auctions from pastcharactertrades
model Auction {
  id                 Int        @id @default(autoincrement())
  externalId         String     @unique @map("external_id")
  characterName      String     @map("character_name")
  level              Int?
  vocation           String?
  gender             String?
  world              String?
  auctionStart       String?    @map("auction_start")
  auctionEnd         String?    @map("auction_end")
  soldPrice          Int?       @map("sold_price")
  coinsPerLevel      Float?     @map("coins_per_level")
  // Skills
  magicLevel         Int?       @map("magic_level")
  fist               Int?
  club               Int?
  sword              Int?
  axe                Int?
  distance           Int?
  shielding          Int?
  fishing            Int?
  // General stats
  hitPoints          Int?       @map("hit_points")
  mana               Int?
  capacity           Int?
  speed              Int?
  experience         String?
  creationDate       String?    @map("creation_date")
  achievementPoints  Int?       @map("achievement_points")
  mountsCount        Int?       @map("mounts_count")
  outfitsCount       Int?       @map("outfits_count")
  titlesCount        Int?       @map("titles_count")
  linkedTasks        Int?       @map("linked_tasks")
  dailyRewardStreak  Int?       @map("daily_reward_streak")
  // Charm
  charmExpansion     Boolean?   @map("charm_expansion")
  charmPoints        Int?       @map("charm_points")
  unusedCharmPoints  Int?       @map("unused_charm_points")
  spentCharmPoints   Int?       @map("spent_charm_points")
  // Prey & hunting
  preySlots          Int?       @map("prey_slots")
  preyWildcards      Int?       @map("prey_wildcards")
  huntingTaskPoints  Int?       @map("hunting_task_points")
  // Hirelings
  hirelings          Int?
  hirelingJobs       Int?       @map("hireling_jobs")
  // Items
  storeItemsCount    Int?       @map("store_items_count")
  // Other
  bossPoints         Int?       @map("boss_points")
  blessingsCount     Int?       @map("blessings_count")
  exaltedDust        String?    @map("exalted_dust")
  gold               Int?
  bestiary           Int?
  url                String?
  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @default(now()) @updatedAt @map("updated_at")
  watchlistItems     Watchlist[]

  @@index([vocation])
  @@index([level])
  @@index([world])
  @@index([soldPrice])
  @@map("auctions")
}

// Highscore entries scraped from the leaderboard
model HighscoreEntry {
  id            Int      @id @default(autoincrement())
  characterName String   @map("character_name")
  world         String
  vocation      String
  level         Int
  category      String
  rank          Int
  score         BigInt
  capturedDate  DateTime @map("captured_date")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([characterName, world, category, capturedDate])
  @@index([characterName, world])
  @@index([world, category, capturedDate])
  @@index([category, capturedDate])
  @@map("highscore_entries")
}

// Precomputed market statistics
model MarketStats {
  id               Int      @id @default(autoincrement())
  vocation         String
  levelMin         Int      @map("level_min")
  levelMax         Int      @map("level_max")
  avgPrice         Float?   @map("avg_price")
  medianPrice      Float?   @map("median_price")
  minPrice         Int?     @map("min_price")
  maxPrice         Int?     @map("max_price")
  pricePerLevel    Float?   @map("price_per_level")
  pricePerMl       Float?   @map("price_per_ml")
  charmPointValue  Float?   @map("charm_point_value")
  sampleSize       Int?     @map("sample_size")
  calculatedAt     DateTime @default(now()) @map("calculated_at")

  @@unique([vocation, levelMin, levelMax])
  @@index([vocation])
  @@map("market_stats")
}

// User watchlist (for Phase 4)
model Watchlist {
  id              Int      @id @default(autoincrement())
  userId          String?  @map("user_id")
  characterName   String?  @map("character_name")
  auctionId       Int?     @map("auction_id")
  notifyOnChange  Boolean  @default(false) @map("notify_on_change")
  createdAt       DateTime @default(now()) @map("created_at")
  auction         Auction? @relation(fields: [auctionId], references: [id])

  @@index([userId])
  @@index([auctionId])
  @@map("watchlist")
}
