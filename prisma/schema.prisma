// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Worlds reference table
model World {
  id         Int         @id @default(autoincrement())
  name       String      @unique @db.VarChar(100)
  pvpType    String?     @map("pvp_type") @db.VarChar(50)
  isActive   Boolean     @default(true) @map("is_active")
  createdAt  DateTime    @default(now()) @map("created_at")
  characters Character[]

  @@map("worlds")
}

// Characters (canonical record)
model Character {
  id                  Int                  @id @default(autoincrement())
  name                String               @db.VarChar(255)
  worldId             Int                  @map("world_id")
  vocation            String?              @db.VarChar(50)
  guildName           String?              @map("guild_name") @db.VarChar(255)
  firstSeen           DateTime             @default(now()) @map("first_seen")
  lastUpdated         DateTime             @default(now()) @updatedAt @map("last_updated")
  world               World                @relation(fields: [worldId], references: [id])
  characterSnapshots  CharacterSnapshot[]

  @@unique([name, worldId])
  @@index([worldId])
  @@index([name])
  @@map("characters")
}

// Daily character snapshots
model CharacterSnapshot {
  id            Int      @id @default(autoincrement())
  characterId   Int      @map("character_id")
  capturedDate  DateTime @map("captured_date") @db.Date
  level         Int?
  experience    BigInt?
  magicLevel    Int?     @map("magic_level")
  fist          Int?
  club          Int?
  sword         Int?
  axe           Int?
  distance      Int?
  shielding     Int?
  fishing       Int?
  expRank       Int?     @map("exp_rank")
  mlRank        Int?     @map("ml_rank")
  expGained     BigInt?  @map("exp_gained")
  levelsGained  Int?     @map("levels_gained")
  createdAt     DateTime @default(now()) @map("created_at")
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, capturedDate])
  @@index([characterId])
  @@index([capturedDate])
  @@map("character_snapshots")
}

// Auctions from pastcharactertrades (sold, cancelled, expired)
model Auction {
  id                 Int        @id @default(autoincrement())
  externalId         String     @unique @map("external_id") @db.VarChar(100)
  characterName      String     @map("character_name") @db.VarChar(255)
  level              Int?
  vocation           String?    @db.VarChar(50)
  gender             String?    @db.VarChar(20)
  world              String?    @db.VarChar(100)
  auctionStart       String?    @map("auction_start") @db.VarChar(100)
  auctionEnd         String?    @map("auction_end") @db.VarChar(100)
  auctionStatus      String?    @map("auction_status") @db.VarChar(20)  // sold, cancelled, expired
  soldPrice          Int?       @map("sold_price")
  coinsPerLevel      Float?     @map("coins_per_level")
  // Skills
  magicLevel         Int?       @map("magic_level")
  fist               Int?
  club               Int?
  sword              Int?
  axe                Int?
  distance           Int?
  shielding          Int?
  fishing            Int?
  // General stats
  hitPoints          Int?       @map("hit_points")
  mana               Int?
  capacity           Int?
  speed              Int?
  experience         String?    @db.VarChar(50)
  creationDate       String?    @map("creation_date") @db.VarChar(100)
  achievementPoints  Int?       @map("achievement_points")
  mountsCount        Int?       @map("mounts_count")
  outfitsCount       Int?       @map("outfits_count")
  titlesCount        Int?       @map("titles_count")
  linkedTasks        Int?       @map("linked_tasks")
  dailyRewardStreak  Int?       @map("daily_reward_streak")
  // Charm
  charmExpansion     Boolean?   @map("charm_expansion")
  charmPoints        Int?       @map("charm_points")
  unusedCharmPoints  Int?       @map("unused_charm_points")
  spentCharmPoints   Int?       @map("spent_charm_points")
  // Prey & hunting
  preySlots          Int?       @map("prey_slots")
  preyWildcards      Int?       @map("prey_wildcards")
  huntingTaskPoints  Int?       @map("hunting_task_points")
  // Hirelings
  hirelings          Int?
  hirelingJobs       Int?       @map("hireling_jobs")
  // Items
  hasLootPouch       Boolean?   @map("has_loot_pouch")
  storeItemsCount    Int?       @map("store_items_count")
  // Other
  bossPoints         Int?       @map("boss_points")
  blessingsCount     Int?       @map("blessings_count")
  exaltedDust        String?    @map("exalted_dust") @db.VarChar(50)
  gold               Int?
  bestiary           Int?
  url                String?    @db.VarChar(500)
  // Quest availability (true = quest NOT yet done, available for buyer)
  primalOrdealAvailable    Boolean?   @map("primal_ordeal_available")
  soulWarAvailable         Boolean?   @map("soul_war_available")
  sanguineBloodAvailable   Boolean?   @map("sanguine_blood_available")
  // Bid tracking (from current auctions archival)
  minimumBid         Int?       @map("minimum_bid")
  currentBid         Int?       @map("current_bid")
  hasBeenBidOn       Boolean?   @default(false) @map("has_been_bid_on")
  // Skill percentages
  magicLevelPct    Float?   @map("magic_level_pct")
  fistPct          Float?   @map("fist_pct")
  clubPct          Float?   @map("club_pct")
  swordPct         Float?   @map("sword_pct")
  axePct           Float?   @map("axe_pct")
  distancePct      Float?   @map("distance_pct")
  shieldingPct     Float?   @map("shielding_pct")
  fishingPct       Float?   @map("fishing_pct")
  // Extra detail fields
  outfitImageUrl   String?  @map("outfit_image_url") @db.VarChar(500)
  gems             String?  @db.Text
  weeklyTaskExpansion  Boolean?  @map("weekly_task_expansion")
  displayItems     String?  @map("display_items") @db.Text
  outfitNames      String?  @map("outfit_names") @db.Text
  mountNames       String?  @map("mount_names") @db.Text
  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @default(now()) @updatedAt @map("updated_at")
  watchlistItems     Watchlist[]

  @@index([vocation])
  @@index([level])
  @@index([world])
  @@index([soldPrice])
  @@map("auctions")
}

// Highscore entries scraped from the leaderboard
model HighscoreEntry {
  id            Int      @id @default(autoincrement())
  characterName String   @map("character_name") @db.VarChar(255)
  world         String   @db.VarChar(100)
  vocation      String   @db.VarChar(50)
  level         Int
  category      String   @db.VarChar(50)
  rank          Int
  score         BigInt
  capturedDate  DateTime @map("captured_date") @db.Date
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([characterName, world, category, capturedDate])
  @@index([characterName, world])
  @@index([world, category, capturedDate])
  @@index([category, capturedDate])
  @@map("highscore_entries")
}

// Precomputed market statistics
model MarketStats {
  id               Int      @id @default(autoincrement())
  vocation         String   @db.VarChar(50)
  levelMin         Int      @map("level_min")
  levelMax         Int      @map("level_max")
  avgPrice         Decimal? @map("avg_price") @db.Decimal
  medianPrice      Decimal? @map("median_price") @db.Decimal
  minPrice         Int?     @map("min_price")
  maxPrice         Int?     @map("max_price")
  pricePerLevel    Decimal? @map("price_per_level") @db.Decimal
  pricePerMl       Decimal? @map("price_per_ml") @db.Decimal
  charmPointValue  Decimal? @map("charm_point_value") @db.Decimal
  sampleSize       Int?     @map("sample_size")
  calculatedAt     DateTime @default(now()) @map("calculated_at")

  @@unique([vocation, levelMin, levelMax])
  @@index([vocation])
  @@map("market_stats")
}

// Analytics — anonymous visitor sessions
model AnalyticsSession {
  id         String           @id @default(uuid()) @db.Uuid
  visitorId  String           @map("visitor_id") @db.Uuid
  userAgent  String?          @map("user_agent") @db.VarChar(500)
  referrer   String?          @db.VarChar(500)
  startedAt  DateTime         @default(now()) @map("started_at")
  lastSeenAt DateTime         @default(now()) @map("last_seen_at")
  events     AnalyticsEvent[]

  @@index([visitorId])
  @@index([startedAt])
  @@map("analytics_sessions")
}

// Analytics — page views and search events
model AnalyticsEvent {
  id             Int              @id @default(autoincrement())
  sessionId      String           @map("session_id") @db.Uuid
  visitorId      String           @map("visitor_id") @db.Uuid
  eventType      String           @map("event_type") @db.VarChar(50)
  pagePath       String           @map("page_path") @db.VarChar(500)
  referrer       String?          @db.VarChar(500)
  viewportWidth  Int?             @map("viewport_width")
  viewportHeight Int?             @map("viewport_height")
  searchQuery    String?          @map("search_query") @db.VarChar(255)
  createdAt      DateTime         @default(now()) @map("created_at")
  session        AnalyticsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([visitorId])
  @@index([eventType])
  @@index([createdAt])
  @@index([pagePath])
  @@map("analytics_events")
}

// User watchlist (for Phase 4)
model Watchlist {
  id              Int      @id @default(autoincrement())
  userId          String?  @map("user_id") @db.Uuid
  characterName   String?  @map("character_name") @db.VarChar(255)
  auctionId       Int?     @map("auction_id")
  notifyOnChange  Boolean  @default(false) @map("notify_on_change")
  createdAt       DateTime @default(now()) @map("created_at")
  auction         Auction? @relation(fields: [auctionId], references: [id])

  @@index([userId])
  @@index([auctionId])
  @@map("watchlist")
}

// Current (live) auctions from currentcharactertrades
model CurrentAuction {
  id                 Int        @id @default(autoincrement())
  externalId         String     @unique @map("external_id") @db.VarChar(100)
  characterName      String     @map("character_name") @db.VarChar(255)
  level              Int?
  vocation           String?    @db.VarChar(50)
  gender             String?    @db.VarChar(20)
  world              String?    @db.VarChar(100)
  auctionStart       String?    @map("auction_start") @db.VarChar(100)
  auctionEnd         String?    @map("auction_end") @db.VarChar(100)
  // Bid tracking
  minimumBid         Int?       @map("minimum_bid")
  currentBid         Int?       @map("current_bid")
  hasBeenBidOn       Boolean    @default(false) @map("has_been_bid_on")
  // Skills
  magicLevel         Int?       @map("magic_level")
  fist               Int?
  club               Int?
  sword              Int?
  axe                Int?
  distance           Int?
  shielding          Int?
  fishing            Int?
  // General stats
  hitPoints          Int?       @map("hit_points")
  mana               Int?
  capacity           Int?
  speed              Int?
  experience         String?    @db.VarChar(50)
  creationDate       String?    @map("creation_date") @db.VarChar(100)
  achievementPoints  Int?       @map("achievement_points")
  mountsCount        Int?       @map("mounts_count")
  outfitsCount       Int?       @map("outfits_count")
  titlesCount        Int?       @map("titles_count")
  linkedTasks        Int?       @map("linked_tasks")
  dailyRewardStreak  Int?       @map("daily_reward_streak")
  // Charm
  charmExpansion     Boolean?   @map("charm_expansion")
  charmPoints        Int?       @map("charm_points")
  unusedCharmPoints  Int?       @map("unused_charm_points")
  spentCharmPoints   Int?       @map("spent_charm_points")
  // Prey & hunting
  preySlots          Int?       @map("prey_slots")
  preyWildcards      Int?       @map("prey_wildcards")
  huntingTaskPoints  Int?       @map("hunting_task_points")
  // Hirelings
  hirelings          Int?
  hirelingJobs       Int?       @map("hireling_jobs")
  // Items
  hasLootPouch       Boolean?   @map("has_loot_pouch")
  storeItemsCount    Int?       @map("store_items_count")
  // Other
  bossPoints         Int?       @map("boss_points")
  blessingsCount     Int?       @map("blessings_count")
  exaltedDust        String?    @map("exalted_dust") @db.VarChar(50)
  gold               Int?
  bestiary           Int?
  url                String?    @db.VarChar(500)
  // Quest availability
  primalOrdealAvailable    Boolean?   @map("primal_ordeal_available")
  soulWarAvailable         Boolean?   @map("soul_war_available")
  sanguineBloodAvailable   Boolean?   @map("sanguine_blood_available")
  // Skill percentages (progress to next level)
  magicLevelPct    Float?   @map("magic_level_pct")
  fistPct          Float?   @map("fist_pct")
  clubPct          Float?   @map("club_pct")
  swordPct         Float?   @map("sword_pct")
  axePct           Float?   @map("axe_pct")
  distancePct      Float?   @map("distance_pct")
  shieldingPct     Float?   @map("shielding_pct")
  fishingPct       Float?   @map("fishing_pct")
  // Outfit image
  outfitImageUrl   String?  @map("outfit_image_url") @db.VarChar(500)
  // Gems (JSON array of gem objects)
  gems             String?  @db.Text
  // Weekly task expansion
  weeklyTaskExpansion  Boolean?  @map("weekly_task_expansion")
  // Display items (JSON array of item image URLs)
  displayItems     String?  @map("display_items") @db.Text
  // Outfit and mount names (JSON arrays of strings)
  outfitNames      String?  @map("outfit_names") @db.Text
  mountNames       String?  @map("mount_names") @db.Text
  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @default(now()) @updatedAt @map("updated_at")
  // Track if auction has ended (moved to past auctions)
  isActive           Boolean    @default(true) @map("is_active")

  @@index([vocation])
  @@index([level])
  @@index([world])
  @@index([currentBid])
  @@index([isActive])
  @@map("current_auctions")
}

// World types and transfer rules
model WorldType {
  id          Int      @id @default(autoincrement())
  worldName   String   @unique @map("world_name") @db.VarChar(100)
  pvpType     String   @map("pvp_type") @db.VarChar(50)   // "Optional PvP", "Open PvP", "Retro Open PvP"
  isRtc       Boolean  @default(false) @map("is_rtc")      // Updated to RTC (Rubini Trading Coins)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("world_types")
}

// User feedback submissions
model Feedback {
  id        Int      @id @default(autoincrement())
  type      String   @db.VarChar(50)   // "bug", "feature", "general"
  message   String   @db.Text
  page      String?  @db.VarChar(500)
  email     String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([type])
  @@index([createdAt])
  @@map("feedback")
}
